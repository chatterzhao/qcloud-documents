## 避免重复登录

执行登录流程之前，我们非常建议您**先判断用户端是否已经登录 CloudBase**，如已经登录，那么不需要执行登录流程，以**避免无意义的重复登录**。

**Web**

```js
/**
     * 1.匿名登录
     * 2.auth.getLoginState()是 auth.hasLoginState 的异步模式,文档链接：https://docs.cloudbase.net/api-reference/webv2/authentication.html#auth-hasloginstate
     */
// 请自行引入 SDK。
// 将下一行代码复制到您的HTML代码底部，其他script标记之前。
// <script src="//imgcache.qq.com/qcloud/cloudbase-js-sdk/1.3.3/cloudbase.js"></script>
// 1.3.3是版本，最新版本请查看：https://www.npmjs.com/package/@cloudbase/js-sdk

const app = cloudbase.init({
    env: 'XXXX',
});

async function login() {
    await app.auth({
        // 登录状态的持久保留（local 30天失效 session(默认)关闭窗口失效 none 刷新后失效）
        persistence: 'local',
    })
        .anonymousAuthProvider()
        .signIn()
        .then((res) => {
            //登录成功
            // 可以对res进行处理，比如获取uid：res.user.uid
        })
        .catch(err => {
            console.log("登录失败,err信息为：", err);
        });
};

// 判断登录状态，避免重复登录
// 注意这里判断登录状态，至于选择下面的哪种选项，看测试时要注意操作与预期是否一致：
// session（代码不指明，默认是它）	在 SessionStorage 中保留登录状态，当前页面关闭后会被清除。
// local（最容易测试是否已登录的选项）	在本地存储中长期地保留登录状态。
// none	在内存中保留登录状态，当前页面刷新、重定向之后会被清除。
const auth = app.auth({ persistence: "local" });
const loginState = auth.hasLoginState();
if (loginState) {
    // 登录态有效
    // 可以对loginState进行处理，比如获取uid:loginState.user.uid;
} else {
    // 没有登录态，或者登录态已经失效，调用登录函数执行登录
    // 如果代码后面使用登录返回的信息进行进一步操作，建议使用 async await 语法替换下面的 login(); 代码，如，async function clickLogin(){await login();}
    // 在一个button按钮上绑定 clickLogin 函数
    login();
};
```

## 登录状态的持久保留

您可以指定登录状态如何持久保留。默认为 `session`，相关选项包括：

| 值        | 说明                                                       |
| --------- | ---------------------------------------------------------- |
| `session` | 在 SessionStorage 中保留登录状态，当前页面关闭后会被清除。 |
| `local`   | 在本地存储中长期地保留登录状态。                           |
| `none`    | 在内存中保留登录状态，当前页面刷新、重定向之后会被清除。   |

例如，对于网页应用，最佳选择是 `local`，即在用户关闭浏览器之后仍保留该用户的会话。这样，用户不需要每次访问该网页时重复登录，避免给用户带来诸多不便体验。

**Web**

```js
const auth = app.auth({
  persistence: "local"
});
```
